= Настройка полнотекстового поиска

Полнотекстовый поиск в системе {dv} -- это поиск карточек, содержащих заданную строку в данных и/или в связанных файлах.

.Полнотекстовый поиск может использоваться для:
* Поиска точного совпадения слов.
* Поиска слов, начинающихся с заданной последовательности букв, например, по ключевому слову "приказ" будут отобраны слова "приказываю", "приказать" и подобные.
* Морфологического поиска -- поиска с учетом словоформ.

Полнотекстовый поиск может искать данные, которые были проиндексированы сервисом полнотекстового индексирования {dv}. Данный сервис передает данные во внешнюю систему поиска, которая непосредственно индексирует их и предоставляет ответы на поисковые запросы.

.{dv} поддерживает две системы полнотекстового поиска:
* Встроенная в {mssql} Server система поиска -- только для БД {mssql} Server.
* Система полнотекстового поиска {es} -- для БД {mssql} Server и {pgsql}.

Одна база данных может быть настроена на работу только с одной системой полнотекстового поиска. К одному сервису полнотекстового индексирования могут быть подключены несколько баз данных {dv}, индексируемых с помощью разных систем полнотекстового поиска.

[#how-it-works]
== Особенности работы полнотекстового поиска

. Полнотекстовый поиск от {mssql} работает по *префиксу*. Соответственно, будут найдены только строки, где слово *начинается* с части введённой в поисковую строку.

. Добавленные недавно данные (например, созданная карточка) станут доступны для нахождения поиском в клиентской программе не сразу, а через какое-то время. Этот временной промежуток между добавлением данных и формированием индексов определяется периодом формирования очереди обработки и периодом обработки этой очереди сервисом полнотекстового индексирования. Очередь обработки выполняется задачей в SQL Server с периодичностью 5 минут.
+
. Качество поиска в {es} и SQL Server может различаться из-за особенностей формирования индексов, учитывающих морфологию языка:
+
* Для поиска в SQL Server может передаваться более короткая часть искомого слова, чем необходима {es}.
+
****
Например, для поиска документов с названием `Исходящий …` с помощью SQL Server пользователю достаточно ввести `исх`, в {es} -- `исходящ`.
****
+
* Результаты поиска в {es} могут содержать записи, не полностью совпадающие со словами поисковой фразы (менее жесткий поиск, чем в SQL Server).
+
****
Например, при поиске по фразе `исходящ ном2`, результат может содержать записи `Исходящий номер1`, `Исходящий номер2` и т.п.
****
+
* В некоторых вариантах поисковой фразы {es} может не возвращать результаты.
+
. Полнотекстовый поиск по содержимому файлов карточек поддерживается не для всех файлов.
+
****
.При использовании встроенной в {mssql} Server системы поискаfootnote:[Должны быть установлены компоненты Microsoft Office 2010 Filter Packs и Adobe PDF IFilter 11.0.1.]:
- Файлы `.pdf`.
- Файлы Microsoft Office.

.При использовании системы полнотекстового поиска "{es}"footnote:[Необходимо скачать и установить словари Hunspell]: `.pdf`, файлы Microsoft Office (`.docx`, `.doc`, `.xlsx`, `.xls`, `.pptx`, `.ppt`, `.rtf`), `.hml` и `.txt`.
****
+
. Если вы настраиваете систему полнотекстового поиска, чтобы искать документы по номеру, выбирайте для индексации секцию _Номера_, а не поля _Регистрационный номер_, _Исходящий номер_ в секции _Основная информация_.
+
В прочих карточках необходимо следовать схожей логике: проверять наличие похожей секции и при необходимости выбирать её.

// tag::install-ft[]
[#install-ft]
== Установка сервиса полнотекстового индексирования

. Установите сервис полнотекстового индексирования, предварительно обновив индекс пакетов:
+
[source,bash]
----
sudo apt-get update
sudo apt-get install docsvision-fulltextservice
----
+
. Все настройки сервиса полнотекстового индексирования хранятся в конфигурационном файле `appsettings.json`. Откройте конфигурационный файл в любом текстовом редакторе, например `nano`:
+
[source,bash]
----
sudo nano /usr/lib/docsvision/fulltextservice/appsettings.json
----
+
. Выполните необходимые настройки сервиса:
+
--
[source,json]
----
{
  "DocsVision": {
    "Platform": {
      "Server": {
        "LogFile": "/var/log/docsvision/fulltextservice.log" <.>
        "Databases": {
          "alias": "CONNECTION-STRING" <.>
        }
      }
    }
  },
  "DataProtectCertificateThumbprint": "thumbprint", <.>
  "SystemUserAccount": "account@domain.com", <.>
  "SystemUserPassword": "password" <.>
}
----
<.> Путь к файлу журнала полнотекстового поиска.
<.> Строка подключения к индексируемой БД.
<.> Отпечаток закрытого ключа шифрования SHA1. +
Указывается без двоеточия, например, `D8602179888DC8402B393F11DCA16A3376DDF879`, см. подробнее в документации по установке системы, раздел "xref:dev@install-linux::appendix/account-protection.adoc[]". +
Если шифровать пароль системной учётной записи не планируется, параметр можно удалить.
<.> Имя системной учётной записи {dv}.
+
include::ROOT:partial$excerpts.adoc[tags=system-accounts]
+
<.> Пароль системной учётной записи рекомендуется хранить в зашифрованном виде. Подробнее про шифрование см. в документации по установке системы, раздел "xref:install-linux:ROOT:appendix/account-protection.adoc[]".
--
+
. Запустите сервис полнотекстового поиска следующей командой:
+
[source,bash]
----
sudo systemctl start dvfulltextservice
----
// end::install-ft[]
// include::admin:partial$update.adoc[tags=config]

[#connection-string]
== Строка подключения к БД

.{mssql}
****
`Initial Catalog=Имя-БД; Data Source=Полное-имя-сервера-СУБД; User ID=Имя-пользователя; Password=Пароль-пользователя;`
****

.{pgsql}
****
`Server=Адрес-сервера-базы-данных; Port=SQL-порт; Database=Название-БД; User ID=Имя-пользователя; Password=Пароль-пользователя;`
****
