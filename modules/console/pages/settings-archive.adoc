:page-aliases: archive-data.adoc \
archive-logs

= Настройки архивирования

[#data]
== Особенности хранения архивных данных в {dv}

Архив {dv} предназначен для хранения неиспользуемых в оперативной деятельности данных, которые при этом представляют интерес для организации.

В зависимости от настроек, архивные данные могут храниться в основной БД {dv} (таблицы с архивными данными имеют постфикс *\_archive*) или в отдельной _архивной базе данных_.

Архивная база данных -- xref:db-satellite.adoc[сателлитная база данных] {dv}, которая предназначена для хранения данных архивных карточек. Архивная база данных имеет название: *Название-основной-БД-{dv}_Archive*.

Использование отдельной БД для хранения архивных карточек позволяет снизить нагрузку на основную БД, облегчить её обслуживание и сократить время на создание её резервных копий.

Чтобы использовать архивную БД, лицензия {dv} должна содержать опцию _{dv} Архивная база данных_.

Способ хранения архивных данных определяется при создании БД {dv}, и не может быть изменён без последствий после создания. См. подробнее о сателлитных БД в пункте xref:db-satellite.adoc[].

Карточка перемещается в архив, если к ней добавлен атрибут _Архивирована_ (см. подробнее в документации по работе с модулем {wincl}, в разделе "xref:5.5.4@winclient:user:archive.adoc[]"). Карточка будет извлечена из архива, если атрибут удалён. Карточки, находящиеся в архиве, доступны только для чтения.

Помещать карточки в архив, извлекать карточки из архива, открывать архивированные карточки и находить их с помощью поисковых запросов могут пользователи, входящие в одну из следующих групп:

* *{dv-arch-ops-serv}*.
* *{dv-admins-serv}*.
* *{dv-sec-admins-serv}*.

Для всех остальных пользователей карточки в архиве недоступны и не отображаются в клиентских программах.

Правом на удаление архивных карточек обладают только пользователи, включённые в группу *{dv-arch-ops-serv}* (_{dv-arch-ops-dir}_).

[#logs]
== Архивирование журналов работы

По умолчанию из журналов работы {dv} удаляется информация старше 7 дней. Администратор может включить резервное копирование удаляемых данных, изменить параметры очистки или отключить очистку.

. Откройте _{cns}_
. Перейдите в раздел настроек menu:Настройки сервера[Базы данных].
. Выберите настраиваемую базу данных и нажмите на кнопку *Настройки*, чтобы открыть xref:db-config.adoc[Панель настроек базы данных].
. Перейдите на страницу _Журнал_.
. Настройте параметры архивирования для нужного журнала:
+
- _{pl}_,
- _Безопасность_,
- _Приложение_.
+
****
.. Нажмите на кнопку *…* в блоке {pl}, _Безопасность_ или _Приложение_, чтобы открыть окно _Параметры резервного копирования/очистки журнала_.
+
.Параметры резервного копирования/очистки журнала
image::admin:backup-clean-parameters.png[Параметры резервного копирования/очистки журнала]
+
.. Выберите критерий архивирования:
+
* *Выгружать/очищать сообщения журнала старше, чем (дни)* -- записи старше указанного срока будут удаляться.
* *Выгружать/очищать журнал, оставив в нем (кол-во сообщений)* -- старые записи будут удаляться, а указанное количество новых записей будет оставлено.
+
В данном режиме может остаться большее число записей, чем указано в настройке. Записи суммируются по дням, пока не будет достигнуто указанное значение, но число записей не округляется до указанного значения и может его превысить. Записи за самый крайний день будут оставлены полностью.
+
[NOTE]
====
Очищаемые данные удаляются из БД не сразу, а временно перемещаются в таблицу *_backup*. Окончательно данные удаляются или перемещаются в папку резервных копий (в зависимости от настроек) на следующем цикле выполнения задачи очистки журналов.
====
+
* *Не выгружать/очищать журнал* -- удаление записей и журнала не будет выполняться.
+
.. Установите флаг `*Папка для резервных копий*`, чтобы удаляемые из БД данные сохранялись, и укажите папку для сохранения.
+
Сохранение выполняется на сервере БД {dv} (Microsoft SQL или {pgsql}), поэтому папка для резервных копий должна быть указана относительно файловой системы ОС с СУБД.
+
При работе БД Microsoft в режиме xref:db-always-on.adoc[AlwaysOn] архивы сохраняются на мастере.
****
+
. Сохраните настройки.
